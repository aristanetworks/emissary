# syntax = docker/dockerfile:1.3

FROM golang:1.23.3-alpine3.20 as builder

WORKDIR /build

# Copy Go module files
COPY go.mod go.sum ./
COPY vendor vendor

# Copy required source code
COPY cmd/kat-server cmd/kat-server
COPY pkg pkg
COPY api api

# Build the binary
RUN --mount=type=cache,target=/root/.cache/go-build \
    go build -mod=vendor -trimpath -o /kat-server ./cmd/kat-server

FROM alpine:3.20

WORKDIR /work

# Set environment for debugging
ENV GRPC_VERBOSITY=debug \
    GRPC_TRACE=tcp,http,api

# Copy the binary
COPY --from=builder /kat-server /work/kat-server

# Copy certificates from build context (these are generated by testcert-gen before docker build)
# Build context is the repo root, so path is docker/kat-server/
COPY docker/kat-server/server.crt /work/server.crt
COPY docker/kat-server/server.key /work/server.key

CMD ["kat-server"]
